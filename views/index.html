{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block head %}
  {{ super() }}
{% endblock %}
{% block body %}

<h2>dupload</h2>

<form id="uform" method="post" action="/items" enctype="multipart/form-data">
  <input type="file" name="upload" value="browse" />
  <input type="text" name="size" hidden />
  <input type="text" name="description" />
  <input type="submit" value="upload" />
</form>

<h3>items

<select id="cats">
  <option {% if not cat %}selected{% endif %}>all</option>
  {% for cat in cats %}
    <option {% if cat == tab %}selected{% endif %}>{{ cat }}</option>
  {% endfor %}
</select>

</h3>
<table id="items">
  <thead>
    <tr>
      <th>name</th>
      <th>size</th>
      <th>created</th>
      <th>last modified</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
  {% for item in items -%}
    <tr>
      <td><a href="/static/{{ item.cat }}/{{ item.hashname }}">
      {{ item.name }}</a></td>
      <td>{{ item.size }}</td>
      <td>{{ item.created }}</td>
      <td>{{ item.lastmodified }}</td>
      <td>{{ item.description }}</td>
    </tr>
  {% endfor -%}
  </tbody>
</table>

<div class="pagination">
  <a href="?p={{ p-1 }}">prev</a>
  <select>
  {% for i in range(1, tp+1) %}
    <option {% if i == p %}selected{% endif %}>{{ i }}</option>
  {% endfor %}
  </select>
  <a href="?p={{ p+1 }}">next</a>
</div>

<script>
var xhr = new XMLHttpRequest();
xhr.upload.onprogress = function(p) {
    console.log("onprogress", p.loaded);
}
xhr.onreadystatechange=function() {
    console.log("xhr status", xhr.readyState, xhr.status);
    if (xhr.readyState==4 && xhr.status==200) {
        window.location.href = "/items";
    }
}

var uform = document.getElementById("uform");
uform.onsubmit = function(e) {
    e.preventDefault();
    if (ufile.files.length == 0 || ufile.files.length > 1) {
        return;
    }
    var formData = new FormData(uform);
    xhr.open("POST", "/items");
    xhr.send(formData);
}

var ufile = uform["upload"];
var usize = uform["size"];
ufile.onchange = function() {
    if (this.files.length == 0) {
        return;
    }
    var file = this.files[0];
    if (file.size > 8192 * 1024) {
        alert("file too large (expecting <= 8Mb)");
        this.value = null;
        return;
    }
    usize.value = file.size;
}

var cats = document.getElementById("cats");
cats.onchange = function() {
    var cat = cats.selectedOptions[0].value;
    if (cat == "all") {
        window.location.href = "/items";
    } else {
        window.location.href = "?cat=" + cat;
    }
}
</script>
{% endblock %}
